## 2. 浏览器原理系列-浏览器渲染流程详解

- ### 文章链接
  > https://juejin.cn/post/6906470997898362894
- ### 类别
  > `浏览器`
- ### 推荐指数：⭐️⭐️⭐️⭐️
- ### 我想说的（这里会有看法、精读、讲讲文章没提到的知识点等等）
  > 大家应该都知道有个面试题是：当你在浏览器打开一个 url，发生了什么？这篇文章就详细解释了其中的一个重要环节：页面的渲染。以下的内容不完全是文章里讲的，很多是我自己突然想说的，文章只和渲染有关。在 chrome 浏览器里，渲染完全由渲染进程负责，渲染进程是单线程的，其实不仅是渲染，js 的 V8 引擎也由它负责，因为都在一个线程里，所以说 js 和渲染是互斥的，这个单线程通过消息队列不断的执行任务，其中就包括 js 中的宏任务，html、css 的解析也算是一种任务，并且各种任务是有优先级的，并不是谁先产生谁先执行，不仅渲染进程任务有优先级概念，连网络 io 也是有优先级的，比如图片资源会让位与关键资源。
  >
  > 当输入 url 时，浏览器进程会卸载上一个页面（如果有的话），只展示这个页面的不可交互图片。然后判断 url 是否是合法的，如果不是则作为搜索引擎的关键词。如果是合法 url，则交给网络进程处理，网络经进程首先会判断是域名还是 ip，如果是域名会经历 dns 解析过程，顺序是：浏览器 dns 缓存 -> 操作系统缓存 -> `/etc/hosts`配置 -> 本地 dns 服务器 -> 根域名服务器 -> 顶级域名服务器 -> 权威域名服务器，这个流程一般不会走到底，任何一个环节包括 ISP 线路节点都可能有缓存的。dns 解析为 ip 之后，http/s 调用底层的 tcp 协议建立连接，首先是三次握手，交换确定了 seq 系列号，确定了双方收发能力。如果是 https 协议的话，首先客户端会通过证书确定服务端身份，客户端和服务端通过非对称加密协商出对称加密的密钥，然后后续的 http 报文通过这个密钥加密，中间人没有私钥从而无法知道密钥明文，无法解密报文。当 http 返回头回来时，网络进程将数据交给浏览器进程，浏览器进程通过`content-type`知道资源类型，如果是`text/html`的话，则通知渲染进程与网络进程建立数据管道，后续的 http body 通过这个管理交给渲染进程解析。当渲染进程接受到数据，会通知浏览器进程，浏览器进程清空上一个页面，重新设置导航状态。接着就是渲染进程的工作了：
  >
  > 在拿到 html 后，预解析里面的资源请求并预请求，接着词法、语法解析 html，形成 dom 树。在此期间可能会遇到 css、js 的代码或资源，css 的资源请求不会阻塞 dom 树解析，如果 dom 树解析完 css 还没有解析完成这时才阻塞 render 树以及后续的 layout 树等等的建立。如果遇到 js，不管是代码还是资源都会等全部执行完后才继续 dom 的解析，除非`script`标签有`async`或`defer`属性，`async`会在请求 js 资源时继续 dom 解析，直到资源请求完成立刻开始执行 js，如果多个`script`都有`async`，它们的执行顺序是不确定的。`defer`属性会跳过该 js，继续解析 dom，等 dom 全部解析完成后，`DOMContentLoaded`之前执行，并且保证多个`script`的执行顺序。如果 js 前面有 css 资源，那么直到 css 被解析完才会执行 js，这会导致 css 间接阻塞 dom 的解析。css 也是经过词法、语法解析，由序列化文本变成结构化的 stylesheet，然后会对其中的一些值进行标准化，接着通过继承、css 选择器优先级等规则，向对应的 dom 添加样式，形成了一个 render 树，有些 dom 是不显示的，比如`display: none;`，于是会形成一个 layout 树仅包含有将来会渲染的节点，layout 树会有每个节点要渲染的位置信息。接着会根据一些特殊样式，比如`position: absolute;`、`transform`、`opacity`，形成不同的层，每个层生成自己的绘制命令列表，即 paint 阶段。这些绘制列表会交给合成层，合成层会将当前视口附近区域划定为图块，优先渲染图块区域，其他区域不在视口范围，可以等空闲了再渲染。合成层通过光栅化线程池将绘制命令交给 GPU 绘制并输出位图，这些位图由合成层合成，最后交给浏览器进程里的`biz`组件，位图被放进后缓冲区，等显示器渲染下一帧之前，前、后缓冲区会交换，从而显示最新的页面图片。像`transform 3D`、`opacity`这些 css 样式，由于不涉及回流和重绘，仅仅是图层的变换，所以会跳过前面的 layout、paint 阶段，直接交给合成层，并由 GPU 处理，速度非常快，所以也叫 `css 硬件加速`，是一种日常 css 开发的优化手段。
  >
  > 当然，打开一个页面肯定不止渲染这一件事情，还有比如 js 脚本的执行、内存的回收、tcp 四次挥手等等，这里就不一一细讲了。后续有一系列文章会讲到 V8、GC 相关的知识，诸位可以管中窥豹一番。
