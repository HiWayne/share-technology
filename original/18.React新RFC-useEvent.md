# è°ˆè°ˆ React çš„æ–°ææ¡ˆï¼šuseEvent

2022 å¹´ 5 æœˆ 5 æ—¥ï¼ŒDan Abramov åœ¨ React RFC ä¸Šæäº¤äº†ä¸€ä¸ªæ–° hook çš„ææ¡ˆï¼šuseEventã€‚å…¶ç›®çš„æ˜¯è¿”å›ä¸€ä¸ªæ°¸è¿œå¼•ç”¨ä¸å˜(always-stable)çš„äº‹ä»¶å¤„ç†å‡½æ•°ã€‚

## æ²¡æœ‰ useEvent æ—¶æˆ‘ä»¬å¦‚ä½•å†™äº‹ä»¶å‡½æ•°

é¦–å…ˆæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™æ®µä»£ç 

```js
function Chat() {
  const [text, setText] = useState("");

  const onClick = () => {
    sendMessage(text);
  };

  return <SendButton onClick={onClick} />;
}
```

ä¸ºäº†è®¿é—®æœ€æ–°çš„ stateï¼Œ`onClick`åœ¨æ¯æ¬¡`Chat`ç»„ä»¶å‘ç”Ÿæ›´æ–°æ—¶ï¼Œéƒ½ä¼šå£°æ˜ä¸€ä¸ªæ–°çš„å‡½æ•°(å¼•ç”¨å˜åŒ–)ï¼Œè¿™ä¼šå¯¼è‡´`SendButton`ç»„ä»¶æ¯æ¬¡éƒ½æ¥å—ä¸€ä¸ªæ–°çš„ propï¼ŒReact çš„æ¯”è¾ƒä¸¤ä¸ªç»„ä»¶èŠ‚ç‚¹æ˜¯å¦è¦ diff å‰ï¼Œä¼šå¯¹ props åšæµ…æ¯”è¾ƒ(Object.is)ï¼Œæ‰€ä»¥æ¯æ¬¡ props æ— æ„ä¹‰çš„å˜åŒ–æ˜¾ç„¶æ˜¯å¯¹ diff æ€§èƒ½ä¸åˆ©çš„ã€‚

åŒæ—¶å®ƒè¿˜ä¼šç ´åä½ çš„ memo ä¼˜åŒ–ï¼Œæ¯”å¦‚ä½ çš„`SendButton`åšäº†å¦‚ä¸‹è®¾è®¡ï¼š

```js
const SendButton = React.memo(() => {});
```

è¿™æ—¶ä½ å¯èƒ½ä¼šæƒ³åˆ°ä½¿ç”¨`useMemo`æˆ–è€…`useCallback`æ¥ä¼˜åŒ–çˆ¶ç»„ä»¶çš„`onClick`å‡½æ•°

```js
function Chat() {
  const [text, setText] = useState("");

  const onClick = useCallback(() => {
    sendMessage(text);
  }, [text]);

  return <SendButton onClick={onClick} />;
}
```

ä½†æ˜¯è¿™æ ·å½“`text`å˜åŒ–æ—¶ï¼Œå¼•ç”¨è¿˜æ˜¯ä¼šå˜åŒ–ï¼Œä¾ç„¶ä¼šå¸¦æ¥å­ç»„ä»¶çš„ä¸å¿…è¦æ›´æ–°ï¼Œè®¾è®¡ä¸å½“ç”šè‡³ä¼šè§¦å‘å­ç»„ä»¶ useEffect çš„ re-firedã€‚`SendButton`æ ¹æœ¬ä¸å…³å¿ƒ`text`çš„å˜åŒ–ã€‚è€Œä¸”å½“å‡½æ•°éå¸¸å¤æ‚æ—¶ï¼Œå¯èƒ½ä¼šæ¼å†™ä¾èµ–ï¼ˆå½“ç„¶ä½ å¯ä»¥é€šè¿‡ eslint æ¥ä¿è¯ï¼‰ï¼Œå¯¼è‡´æ¯æ¬¡ä½¿ç”¨çš„éƒ½æ˜¯åˆå§‹ stateï¼Œä»è€Œé€ æˆéš¾ä»¥è¿½è¸ªçš„ bugã€‚

è€Œæ–°çš„ hook ææ¡ˆ `useEvent`ï¼Œä½ å¯ä»¥åšåˆ°è¿™æ ·ï¼š

```js
function Chat() {
  const [text, setText] = useState("");

  const onClick = useEvent(() => {
    sendMessage(text);
  });

  return <SendButton onClick={onClick} />;
}
```

`onClick`å·²ç»ä¸€ç›´æ˜¯å¼•ç”¨ä¸å˜çš„äº†ï¼Œè€Œä¸”å¯ä»¥è®¿é—®åˆ°æœ€æ–°çš„ textã€‚

## useEvent æ˜¯å¦‚ä½•å®ç°çš„

å®ƒçœ‹ä¸Šå»å¥½åƒå¾ˆç¥å¥‡ï¼Œä½ ä¹Ÿå¯ä»¥è‡ªå·±ç®€å•å®ç°ä¸€ä¸ªç±»ä¼¼çš„ hookï¼Œæœ€æ ¸å¿ƒçš„åœ°æ–¹å°±æ˜¯ä½¿ç”¨ useRef ç»´æŒæœ€æ–°å¼•ç”¨ä»¥åŠç¼“å­˜ä½å¤–å±‚çš„ functionï¼š

```js
const useEvent = (eventHandler) => {
  const eventHandlerRef = useRef(eventHandler);

  // æ¯æ¬¡useEventè¢«è°ƒç”¨éƒ½è¿”å›ä¸å˜çš„å€¼ï¼Œä½†å†…éƒ¨å®é™…æ‰§è¡Œçš„æ˜¯æœ€æ–°çš„å‡½æ•°
  return useMemo((...args) => {
    return eventHandlerRef.current(...args);
  }, []);
};
```

å®˜æ–¹ç»™çš„ä¸€ä¸ªç±»ä¼¼å®ç°æ˜¯è¿™æ ·çš„ï¼š

```js
// (!) Approximate behavior

function useEvent(handler) {
  const handlerRef = useRef(null);

  // In a real implementation, this would run before layout effects
  useLayoutEffect(() => {
    handlerRef.current = handler;
  });

  return useCallback((...args) => {
    // In a real implementation, this would throw if called during render
    const fn = handlerRef.current;
    return fn(...args);
  }, []);
}
```

å…¶å®ï¼ŒçœŸæ­£çš„å®ç°æ¯”èµ·ä¸Šè¿°ä¸¤ç§æ–¹å¼è¦å¤æ‚ä¸€äº›ï¼Œä½œä¸ºä¸€ä¸ªä½¿ç”¨åº¦æå¹¿çš„æ¡†æ¶ï¼Œå¿…é¡»è¦éœ€è¦è€ƒè™‘ä¸€äº›è¾¹ç•Œæ¡ä»¶å’Œçº¦æŸã€‚

1. åœ¨ç»„ä»¶ render æ—¶ä½¿ç”¨è¢« useEvent åŒ…è£¹çš„å‡½æ•°éœ€è¦æŠ›å‡ºé”™è¯¯ã€‚å› ä¸ºå®ƒçš„è®¾è®¡æ˜¯ä¸ºäº†åŒ…è£¹äº‹ä»¶å‡½æ•°ï¼Œäº‹ä»¶å‡½æ•°ä¸åº”è¯¥åœ¨ render æ—¶è°ƒç”¨ã€‚è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆä¸Šè¿°ä»£ç æœ‰`useLayoutEffect`ï¼Œå®ƒä¹Ÿä¿è¯äº†æ¯æ¬¡äº‹ä»¶è§¦å‘æ—¶éƒ½æ˜¯æœ€æ–°çš„ï¼Œå› ä¸ºè§†å›¾/äº‹ä»¶çš„æ›´æ–°ä¸€å®šåœ¨`useLayoutEffect`ä¹‹åã€‚åŒæ—¶ï¼ŒuseEvent å†…éƒ¨ä¿®æ”¹ state ä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºå®ƒä¸ä¼šåœ¨ render æœŸé—´è¢«è°ƒç”¨ï¼Œä¸ä¼šä¿®æ”¹ç»„ä»¶çš„ outputã€‚

2. å…¶å®`handlerRef.current`çš„æ›´æ–°å‘ç”Ÿåœ¨æ¯”æ‰€æœ‰`useLayoutEffect`æ›´æå‰çš„æ—¶åˆ»ï¼Œè¿™ä¸ªä¿è¯äº†å½“ layout æ—¶ï¼Œä¸ä¼šå­˜åœ¨æ—§ç‰ˆæœ¬çš„ handlerï¼Œä¸ä¼šå‡ºç°çŠ¶æ€å‰²è£‚çš„é—®é¢˜

3. ç¬¬ 1 å¤„çš„è®¾è®¡è¿˜é—´æ¥çš„ä¼˜åŒ–äº†æœåŠ¡ç«¯æ¸²æŸ“çš„å®‰å…¨å’Œæ€§èƒ½ï¼Œå› ä¸ºå®ƒä¸èƒ½åœ¨ render æ—¶è¿è¡Œï¼Œè€ŒæœåŠ¡ç«¯æ˜¯ä¸å­˜åœ¨äº‹ä»¶çš„ï¼Œé¿å…äº†æŠ¥é”™ã€‚åŒæ—¶ï¼Œæ—¢ç„¶ useEvent å¯¹æœåŠ¡ç«¯æ¸²æŸ“æ²¡æœ‰æ„ä¹‰ï¼Œé‚£ä¹ˆæœåŠ¡ç«¯æ„å»ºçš„åŒ…é‡Œå¯ä»¥è·³è¿‡ useEvent çš„æ‰“åŒ…ï¼Œä¼˜åŒ–äº†åŒ…ä½“ç§¯ã€‚

## ä½ ä»€ä¹ˆæ—¶å€™ä¸åº”è¯¥ä½¿ç”¨ useEvent

1. æ™®é€šçš„å‡½æ•°ï¼ˆéäº‹ä»¶å›è°ƒï¼‰ä¾ç„¶ç”¨åŸæ¥çš„ useCallback

```js
function ThemedGrid() {
  const theme = useContext(ThemeContext);
  const renderItem = useCallback(
    (item) => {
      // Called during rendering, so it's not an event.
      return <Row {...item} theme={theme} />;
    },
    [theme]
  );
  return <Grid renderItem={renderItem} />;
}
```

å› ä¸ºæœ‰ render æ—¶æœŸçš„æŠ¥é”™æœºåˆ¶ï¼Œå¼€å‘è€…ä¹Ÿä¸å¤ªå¯èƒ½åœ¨è¿™ç§åœºæ™¯ä¸‹ç”¨ useEvent

2. ä¸æ˜¯æ‰€æœ‰çš„ useEffect ä¾èµ–å‡½æ•°éƒ½åº”è¯¥æ˜¯äº‹ä»¶

```js
function Chat({ selectedRoom }) {
  const { createKeys } = useContext(EncryptionSettings);
  // ...
  useEffect(() => {
    const socket = createSocket("/chat/" + selectedRoom, createKeys());
    // ...
    socket.connect();
    return () => socket.disconnect();
  }, [selectedRoom, createKeys]); // âœ… Re-runs when room or createKeys changes
}
```

è¿™é‡Œçš„`createKeys`ä¸åº”è¯¥ä½¿ç”¨ useEventï¼Œå› ä¸º effect ä¸­çš„å‡½æ•°ä¸æ˜¯äº‹ä»¶ï¼Œä¹Ÿä¸éœ€è¦ä¿æŒå¼•ç”¨ä¸å˜ï¼Œå› ä¸ºå®ƒéœ€è¦åœ¨`createKeys`å˜åŒ–æ—¶é‡æ–°å»ºç«‹ socket

3. å¯èƒ½ä¼šå¯¼è‡´ useEffect ä¸å†å“åº”å¼

ä¸‹é¢æ˜¯ä¸€ä¸ªé”™è¯¯çš„å†™æ³•

```js
function Chat({ selectedRoom, theme }) {
  // ...
  // ğŸ”´ This should not be an event!
  const createSocket = useEvent(() => {
    const socket = createSocket("/chat/" + selectedRoom);
    socket.on("connected", async () => {
      await checkConnection(selectedRoom);
      onConnected(selectedRoom);
    });
    socket.on("message", onMessage);
    socket.connect();
    return () => socket.disconnect();
  });
  useEffect(() => {
    return createSocket();
  }, []);
}
```

è¦çŸ¥é“ä¸€ç‚¹çš„æ˜¯ï¼ŒuseEvent æ˜¯éå“åº”å¼çš„ã€‚å› ä¸ºå®ƒæ˜¯äº‹ä»¶ï¼Œæœ€ç»ˆä¼šè¢«åŠ¨è°ƒç”¨ï¼Œå¹¶ä¸éœ€è¦éšç€çŠ¶æ€å˜åŒ–è€Œç«‹å³å“åº”ã€‚æ‰€ä»¥å½“`selectedRoom`å˜åŒ–æ—¶ï¼Œeffect ä¸å†é‡æ–°å»ºç«‹ socket äº†ï¼Œå°½ç®¡`createSocket`å§‹ç»ˆå¯ä»¥æ‹¿åˆ°æœ€æ–°çš„`selectedRoom`ï¼Œä½†å®ƒéœ€è¦çš„æ˜¯ä¸»åŠ¨è§¦å‘ã€‚

æ­£ç¡®çš„å†™æ³•åº”è¯¥æ˜¯ä½¿ç”¨`useCallback`ä¸”ä¾èµ–`selectedRoom`ï¼Œ`useEffect`ä¾èµ–`useCallback`

## useEvent çš„ã€ç¼ºç‚¹ã€æ˜¯ä»€ä¹ˆ

1. æ¯«æ— ç–‘é—®å®ƒå¢åŠ äº† hooks çš„æ¦‚å¿µï¼Œå¸¦æ¥äº†æ›´å¤šçš„å¿ƒæ™ºè´Ÿæ‹…ï¼Œä½ éœ€è¦åˆ¤æ–­è¿™é‡Œè¯¥ä¸è¯¥ç”¨ useEventï¼Œè¿˜æ˜¯ç”¨ useCallback

2. ç”±äºéœ€è¦ä¸€ä¸ªæ¯” layoutEffect æ›´æå‰çš„æ—¶æœŸï¼Œå®ƒä¸å¯é¿å…çš„éœ€è¦æ”¹åŠ¨ fiber tree commit é˜¶æ®µçš„é€»è¾‘ã€‚ä½†æ˜¯ç›¸æ¯”äºè®©ç¤¾åŒºåœ¨ç¬¬ä¸‰æ–¹åº“ä¸­è‡ªè¡Œæä¾›å„è‡ªçš„ä¸å®Œç¾çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™ç§ä»˜å‡ºè¿˜æ˜¯å€¼å¾—çš„ã€‚

3. å®ƒçš„è¡¨ç°ä¼¼ä¹è¶…å‡ºäº†å•çº¯çš„ event è¾¹ç•Œï¼Œæ›´åº”è¯¥å«`useStableCallback`æˆ–è€…`useCommittedCallback`ï¼Œå®˜æ–¹ç»™å®ƒå–`useEvent`è¿™ä¸€åå­—ï¼Œæ˜¯ä¸ºäº†å¸®åŠ©å¼€å‘è€…ä»¬æ›´å®¹æ˜“å»ºç«‹ã€å®ƒåº”è¯¥è¢«ç”¨äºäº‹ä»¶ã€è¿™ä¸€å¿ƒæ™ºæ¨¡å¼ã€‚

4. å®ƒæœ‰ä¸€äº›ç‰¹æ®Šçš„è¾¹ç•Œæ¡ä»¶ä¸‹ä¼šå‡ºç°é—®é¢˜ï¼Œä¸è¿‡è¿™ä¸»è¦æ˜¯å› ä¸ºä»£ç ç¼–å†™æœ‰é—®é¢˜å¸¦æ¥çš„ï¼Œå¹¶ä¸æ˜¯å®ƒè‡ªèº«çš„é—®é¢˜ã€‚ä½†æ­£å› ä¸ºäººæ˜¯æœ€éš¾æ§åˆ¶çš„ï¼Œæ‰€ä»¥è¿™ç§é—®é¢˜ä¹Ÿæ˜¯æœ€éš¾é˜»æ­¢çš„ï¼Œå¼€å‘è€…åº”è¯¥æ›´æ³¨æ„è‡ªå·±çš„ä¹¦å†™è§„èŒƒï¼š

æ¯”å¦‚ useEvent é‡Œé¢æœ‰å¼‚æ­¥é€»è¾‘

```js
function App() {
  const [count, setCount] = useState(0);

  const sayCount = useEvent(async () => {
    console.log(count);
    await wait(1000);
    console.log(count);
  });

  return <Child onClick={sayCount} />;
}
```

await å‰åè¾“å‡ºå€¼æ˜¯ä¸€æ ·çš„ï¼Œå› ä¸º await åé¢çš„å›è°ƒä¿å­˜äº† count é—­åŒ…ã€‚count ä»…ä»…æ˜¯æœ¬æ¬¡ render çš„çŠ¶æ€å¿«ç…§ï¼Œæ‰€ä»¥å‡½æ•°å†…å¼‚æ­¥ç­‰å¾…æ—¶ï¼Œå³ä¾¿å¤–éƒ¨åˆæŠŠ count æ”¹äº†ï¼Œå½“å‰è¿™æ¬¡å‡½æ•°è°ƒç”¨è¿˜æ˜¯æ‹¿ä¸åˆ°æœ€æ–°çš„ countï¼Œè€Œ ref æ–¹æ³•æ˜¯å¯ä»¥çš„ã€‚æ‰€ä»¥äº‹ä»¶ä¸­å°½é‡ä¸è¦æœ‰å¼‚æ­¥ã€‚

å¦å¤–è¿˜æœ‰ã€æ¡ä»¶åˆ¤æ–­å¼çš„ eventã€ï¼Œæ¯”å¦‚ä½ å†™å‡ºäº†è¿™æ ·çš„ä»£ç `onSomething={cond ? handler1 : handler2}`ï¼Œè‡ªç„¶æ˜¯æ²¡åŠæ³•å¸®ä½ ä¿æŒå¼•ç”¨ä¸å˜çš„ã€‚

æ­¤å¤–åœ¨ react æ›´æ–°ä¸­ä¹Ÿä¼šæœ‰ã€å‰²è£‚ã€é—®é¢˜ï¼Œunmounting layout effects æ—¶ä½¿ç”¨çš„æ˜¯ä¸Šä¸€æ¬¡ render æ—¶çš„ eventï¼Œä½†æ˜¯ é layout effect å¸è½½æ—¶ä½¿ç”¨çš„æ˜¯æ–°ç‰ˆæœ¬çš„ eventï¼ˆä¸‹ä¸€æ¬¡æ›´æ–°æ—¶çš„ eventå¯èƒ½å‘ç”Ÿå˜åŒ–äº†ï¼‰ã€‚è¿™å°±ç±»ä¼¼äºåœ¨ unmounting layout å’Œ non-layout effects æœŸé—´è¯» ref ç»“æœä¸ä¸€è‡´çš„æƒ…å†µã€‚

## ä¸ªäººå¯¹ useEvent çš„çœ‹æ³•

useEvent ä¸»è¦ä½œç”¨æ˜¯ç»´æŒå¼•ç”¨ä¸å˜çš„äº‹ä»¶ï¼Œå¯ä»¥ç”¨ååˆ†ç®€æ´çš„ä»£ç å‡å°‘å¼•ç”¨å˜åŒ–å¸¦æ¥çš„é—®é¢˜ã€‚ä½†æ˜¯å®ƒæœ¬èº«ä¹Ÿå¸¦æ¥äº†æ›´å¤šçš„æ¦‚å¿µã€‚æ­£å¦‚ä¸Šé¢çš„ç¼ºç‚¹é‡Œå†™çš„ï¼Œä½ éœ€è¦æ—¶åˆ»æ³¨æ„é‚£äº›é—®é¢˜ã€‚è€Œä¸”ç›®å‰å®˜æ–¹ä¹Ÿä¾ç„¶æœ‰ä¸€äº›å¾…è§£å†³çš„é—®é¢˜[https://github.com/reactjs/rfcs/blob/useevent/text/0000-useevent.md#unresolved-questions](https://github.com/reactjs/rfcs/blob/useevent/text/0000-useevent.md#unresolved-questions)ã€‚æ€»ä¹‹å¯¹äºè¿™ä¸ª RFC ä¸ªäººå¹¶æ²¡æœ‰å¤ªå¤šæ¬£å–œï¼Œå°†æ¥æœ‰åˆ™ç”¨ï¼Œæ¯•ç«Ÿæ˜¯å®˜æ–¹ç»™å‡ºçš„æœ€ä½³å®è·µï¼Œæ²¡æœ‰ä¹Ÿå¯ä»¥æœ‰å…¶ä»–è§£å†³åŠæ³•ã€‚
